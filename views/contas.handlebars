<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerenciamento de Contas</title>
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container mt-5">
      <h2 class="mb-4 text-center">Gerenciamento de Contas</h2>
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>CPF</th>
            <th>Cargo</th>
            <th>Email</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {{#each users}}
          <tr>
            <td>{{this.id}}</td>
            <td>{{this.nome}}</td>
            <td>{{this.cpf}}</td>
            <td>{{this.cargo}}</td>
            <td>{{this.email}}</td>
            <td>
              <button
                class="btn btn-primary btn-sm"
                data-toggle="modal"
                data-target="#editUserModal"
                data-id="{{this.id}}"
                data-nome="{{this.nome}}"
                data-cpf="{{this.cpf}}"
                data-cargo="{{this.cargo}}"
                data-email="{{this.email}}"
              >
                Editar
              </button>
              <button
                class="btn btn-danger btn-sm"
                data-toggle="modal"
                data-target="#deleteUserModal"
                data-id="{{this.id}}"
              >
                Deletar
              </button>
            </td>
          </tr>
          {{/each}}
        </tbody>
      </table>
      <button
        class="btn btn-success"
        data-toggle="modal"
        data-target="#addUserModal"
      >
        Adicionar
      </button>
    </div>

    <!-- Add User Modal -->
    <div
      class="modal fade"
      id="addUserModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="addUserModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addUserModalLabel">Adicionar Usuário</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="addUserForm">
              <div class="form-group">
                <label for="userName">Nome</label>
                <input
                  type="text"
                  class="form-control"
                  id="userName"
                  name="nome"
                  required
                />
              </div>
              <div class="form-group">
                <label for="userCPF">CPF</label>
                <input
                  type="text"
                  class="form-control"
                  id="userCPF"
                  name="cpf"
                  required
                />
              </div>
              <div class="form-group">
                <label for="userCargo">Cargo</label>
                <select class="form-control" id="userCargo" name="cargo" required>
                  <option value="coordenador">Coordenador</option>
                  <option value="diretor">Diretor</option>
                </select>
              </div>
              <div class="form-group">
                <label for="userEmail">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="userEmail"
                  name="email"
                  required
                />
              </div>
              <div class="form-group">
                <label for="userPassword">Senha</label>
                <input
                  type="password"
                  class="form-control"
                  id="userPassword"
                  name="senha"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary">Adicionar</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div
      class="modal fade"
      id="editUserModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="editUserModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editUserModalLabel">Editar Usuário</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="editUserForm">
              <input type="hidden" id="editUserId" name="id" />
              <div class="form-group">
                <label for="editUserName">Nome</label>
                <input
                  type="text"
                  class="form-control"
                  id="editUserName"
                  name="nome"
                  required
                />
              </div>
              <div class="form-group">
                <label for="editUserCPF">CPF</label>
                <input
                  type="text"
                  class="form-control"
                  id="editUserCPF"
                  name="cpf"
                  required
                />
              </div>
              <div class="form-group">
                <label for="editUserCargo">Cargo</label>
                <select class="form-control" id="editUserCargo" name="cargo" required>
                  <option value="coordenador">Coordenador</option>
                  <option value="diretor">Diretor</option>
                </select>
              </div>
              <div class="form-group">
                <label for="editUserEmail">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="editUserEmail"
                  name="email"
                  required
                />
              </div>
              <div class="form-group">
                <label for="editUserPassword">Senha</label>
                <input
                  type="password"
                  class="form-control"
                  id="editUserPassword"
                  name="senha"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary">Salvar</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div
      class="modal fade"
      id="deleteUserModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="deleteUserModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteUserModalLabel">Deletar Usuário</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>Deseja excluir esse usuário?</p>
            <form id="deleteUserForm">
              <input type="hidden" id="deleteUserId" name="id" />
              <button type="submit" class="btn btn-danger">Deletar</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div
      class="modal fade"
      id="successModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="successModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-body">
            <p id="successMessage"></p>
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Fechar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
    $(document).ready(function() {
      function loadUsers() {
        $.ajax({
          url: '/users',
          method: 'GET',
          success: function(users) {
            let rows = '';
            users.forEach(user => {
              rows += `
                <tr>
                  <td>${user.id}</td>
                  <td>${user.nome}</td>
                  <td>${user.cpf}</td>
                  <td>${user.role}</td>
                  <td>${user.email}</td>
                  <td>
                    <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#editUserModal" data-id="${user.id}" data-nome="${user.nome}" data-cpf="${user.cpf}" data-cargo="${user.role}" data-email="${user.email}">Editar</button>
                    <button class="btn btn-danger btn-sm" data-toggle="modal" data-target="#deleteUserModal" data-id="${user.id}">Deletar</button>
                  </td>
                </tr>
              `;
            });
            $('table tbody').html(rows);
          },
          error: function(err) {
            console.error('Erro ao carregar usuários', err);
          }
        });
      }
      
      loadUsers();

      $('#addUserForm').on('submit', function(event) {
        event.preventDefault();
        const formData = $(this).serialize();

        $.ajax({
          url: '/users/add',
          method: 'POST',
          data: formData,
          success: function(response) {
            if (response.success) {
              alert(response.message);
              loadUsers();
              $('#addUserModal').modal('hide');
            } else {
              alert(response.error);
            }
          },
          error: function(error) {
            console.error(error);
            alert('Erro ao adicionar usuário');
          }
        });
      });

      $('#editUserModal').on('show.bs.modal', function(event) {
        const button = $(event.relatedTarget);
        const id = button.data('id');
        const nome = button.data('nome');
        const cpf = button.data('cpf');
        const cargo = button.data('cargo');
        const email = button.data('email');

        const modal = $(this);
        modal.find('#editUserId').val(id);
        modal.find('#editUserName').val(nome);
        modal.find('#editUserCPF').val(cpf);
        modal.find('#editUserCargo').val(cargo);
        modal.find('#editUserEmail').val(email);
      });

      $('#editUserForm').on('submit', function(event) {
        event.preventDefault();
        const formData = $(this).serialize();

        $.ajax({
          url: '/users/edit',
          method: 'POST',
          data: formData,
          success: function(response) {
            if (response.success) {
              alert(response.message);
              loadUsers();
              $('#editUserModal').modal('hide');
            } else {
              alert(response.error);
            }
          },
          error: function(error) {
            console.error(error);
            alert('Erro ao editar usuário');
          }
        });
      });

      $('#deleteUserModal').on('show.bs.modal', function(event) {
        const button = $(event.relatedTarget);
        const id = button.data('id');

        const modal = $(this);
        modal.find('#confirmDeleteButton').data('id', id);
      });

      $('#confirmDeleteButton').on('click', function() {
        const id = $(this).data('id');

        $.ajax({
          url: '/users/delete',
          method: 'POST',
          data: { id },
          success: function(response) {
            if (response.success) {
              alert(response.message);
              loadUsers();
              $('#deleteUserModal').modal('hide');
            } else {
              alert(response.error);
            }
          },
          error: function(error) {
            console.error(error);
            alert('Erro ao excluir usuário');
          }
        });
      });
    });
  </script>
</body>
</html>